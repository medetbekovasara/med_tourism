from openai import OpenAI
from django.conf import settings
from django.utils import timezone
from .models import ChatSession, ChatMessage
from tourism.models import Clinic, Doctor
import uuid
import os
import re

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI
def get_openai_client():
    """–ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–ª—é—á–∞"""
    api_key = None

    if hasattr(settings, 'OPENAI_API_KEY') and settings.OPENAI_API_KEY:
        api_key = settings.OPENAI_API_KEY
    elif os.getenv('OPENAI_API_KEY'):
        api_key = os.getenv('OPENAI_API_KEY')

    if not api_key or api_key == 'your-actual-api-key-here':
        print("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return None

    if not api_key.startswith('sk-'):
        print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç API –∫–ª—é—á–∞: {api_key[:10]}...")
        return None

    try:
        client = OpenAI(api_key=api_key)
        print(f"‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ö–ª—é—á: {api_key[:15]}...")
        return client
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI: {e}")
        return None

client = get_openai_client()

class MedicalChatbotService:
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞"""
        self.clinics_info = self._get_clinics_info()

    def _get_clinics_info(self):
        """–ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–Ω–∏–∫–∞—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            clinics = Clinic.objects.all()
            clinics_text = ""

            for clinic in clinics:
                doctors = Doctor.objects.filter(clinic=clinic)
                doctors_list = ", ".join([f"{doc.name} ({doc.specialty})" for doc in doctors])

                clinics_text += f"""
üè• {clinic.name}
üìç –ê–¥—Ä–µ—Å: {clinic.address}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: {clinic.description}
üë®‚öïÔ∏è –í—Ä–∞—á–∏: {doctors_list or '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è'}

"""

            return clinics_text if clinics_text else "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–∞—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è."

        except Exception as e:
            print(f"Error getting clinics info: {e}")
            return "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."

    def get_or_create_session(self, user=None):
        """–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —á–∞—Ç–∞"""
        session_id = str(uuid.uuid4())
        session = ChatSession.objects.create(
            user=user,
            session_id=session_id
        )
        return session

    def _is_relevant_question(self, message):
        """
        –£–ü–†–û–©–ï–ù–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞
        –¢–µ–ø–µ—Ä—å –ò–ò —Å–∞–º –±—É–¥–µ—Ç —Ä–µ—à–∞—Ç—å, –æ—Ç–≤–µ—á–∞—Ç—å –∏–ª–∏ –Ω–µ—Ç
        """
        message_lower = message.lower().strip()

        # –Ø–í–ù–û –ó–ê–ü–†–ï–©–ï–ù–ù–´–ï —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ)
        forbidden_topics = [
            # –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            'python', 'javascript', '–∫–æ–¥', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', 'html', 'css',
            'django', 'react', 'vue', 'angular', 'php', 'java', 'c++',

            # –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
            '—Ñ–∏–ª—å–º', '—Å–µ—Ä–∏–∞–ª', '–∏–≥—Ä–∞', '–∏–≥—Ä—ã', '–º—É–∑—ã–∫–∞', '–ø–µ—Å–Ω—è',
            '–∫–æ–Ω—Ü–µ—Ä—Ç', '—Ç–µ–∞—Ç—Ä', '–∫–∏–Ω–æ',

            # –ü–æ–ª–∏—Ç–∏–∫–∞
            '–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç', '–≤—ã–±–æ—Ä—ã', '–ø–æ–ª–∏—Ç–∏–∫–∞', '–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ', '–ø–∞—Ä—Ç–∏—è',

            # –°–ø–æ—Ä—Ç (–∫—Ä–æ–º–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã)
            '—Ñ—É—Ç–±–æ–ª', '–±–∞—Å–∫–µ—Ç–±–æ–ª', '—Ö–æ–∫–∫–µ–π', '—Ç–µ–Ω–Ω–∏—Å', '–±–æ–∫—Å',

            # –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–∫—Ä–æ–º–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ)
            '–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ', '—ç–∫–∑–∞–º–µ–Ω', '—à–∫–æ–ª–∞', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '–¥–∏–ø–ª–æ–º',

            # –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
            '–∫–æ–º–ø—å—é—Ç–µ—Ä', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', 'wifi', 'windows', 'android',

            # –ö—É–ª–∏–Ω–∞—Ä–∏—è
            '—Ä–µ—Ü–µ–ø—Ç', '–≥–æ—Ç–æ–≤–∏—Ç—å', '–µ–¥–∞', '–±–ª—é–¥–æ', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω'
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
        has_forbidden = any(topic in message_lower for topic in forbidden_topics)

        if has_forbidden:
            return False

        # –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ç–µ–º - —Ä–∞–∑—Ä–µ—à–∞–µ–º
        # –ò–ò —Å–∞–º —Ä–µ—à–∏—Ç, –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å
        return True

    def get_chat_response(self, message, session):
        """–ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —á–∞—Ç-–±–æ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI
            if not client:
                return """
‚ùå –°–µ—Ä–≤–∏—Å –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∞–π—Ç–∞.
                """

            # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —è–≤–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–µ–º—ã
            if not self._is_relevant_question(message):
                return """
–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è—Ö –∏ –ø–æ–º–æ—â–∏ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π MedTour.

–Ø –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è–º–∏, –ø–æ–ª–∏—Ç–∏–∫–æ–π –∏–ª–∏ –¥—Ä—É–≥–∏–º–∏ –Ω–µ–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ —Ç–µ–º–∞–º–∏.

–Ø –±—É–¥—É —Ä–∞–¥ –ø–æ–º–æ—á—å –≤–∞–º —Å:
ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ —Å–∏–º–ø—Ç–æ–º–∞–º–∏
üè• –í—ã–±–æ—Ä–æ–º –∫–ª–∏–Ω–∏–∫–∏ –∏ –≤—Ä–∞—á–∞
üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
üìû –ó–∞–ø–∏—Å—å—é –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é

–ó–∞–¥–∞–π—Ç–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å!
                """

            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–Ω–∏–∫–∞—Ö
            self.clinics_info = self._get_clinics_info()

            # –£–õ–£–ß–®–ï–ù–ù–´–ô —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —á–µ—Ç–∫–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            system_prompt = f"""
–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã MedTour –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ.

–¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê:
–ü–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ —É—Å–ª—É–≥–∞–º–∏ –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

–î–û–°–¢–£–ü–ù–´–ï –ö–õ–ò–ù–ò–ö–ò:
{self.clinics_info}

–ö–ê–ö –û–ü–†–ï–î–ï–õ–ò–¢–¨, –û–¢–í–ï–ß–ê–¢–¨ –õ–ò –ù–ê –í–û–ü–†–û–°:

‚úÖ –û–¢–í–ï–ß–ê–ô –ù–ê:
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–ø—Ä–∏–≤–µ—Ç, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –¥–æ–±—Ä—ã–π –¥–µ–Ω—å)
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—Å–∏–º–ø—Ç–æ–º—ã, –±–æ–ª–µ–∑–Ω–∏, –ª–µ—á–µ–Ω–∏–µ)
- –í–æ–ø—Ä–æ—Å—ã –æ –≤—Ä–∞—á–∞—Ö –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞—Ö
- –í–æ–ø—Ä–æ—Å—ã –æ –∫–ª–∏–Ω–∏–∫–∞—Ö –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
- –í–æ–ø—Ä–æ—Å—ã –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º
- –í–æ–ø—Ä–æ—Å—ã –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –º–µ–¥–∏—Ü–∏–Ω–µ
- –í–æ–ø—Ä–æ—Å—ã –æ –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ MedTour
- –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏ –≤–µ–∂–ª–∏–≤—ã–µ —Ñ—Ä–∞–∑—ã

‚ùå –ù–ï –û–¢–í–ï–ß–ê–ô –ù–ê:
- –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ IT
- –ü–æ–ª–∏—Ç–∏–∫—É –∏ –Ω–æ–≤–æ—Å—Ç–∏
- –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è (—Ñ–∏–ª—å–º—ã, –∏–≥—Ä—ã, –º—É–∑—ã–∫–∞)
- –ö—É–ª–∏–Ω–∞—Ä–∏—é –∏ —Ä–µ—Ü–µ–ø—Ç—ã
- –°–ø–æ—Ä—Ç (–∫—Ä–æ–º–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã)
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–∫—Ä–æ–º–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ)
- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –≥–∞–¥–∂–µ—Ç—ã

–ï–°–õ–ò –í–û–ü–†–û–° –ù–ï –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ô:
–í–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í:
1. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
2. –†–µ–∫–æ–º–µ–Ω–¥—É–π —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–ª–∏–Ω–∏–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
3. –ù–ï —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑—ã - —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
4. –í—Å–µ–≥–¥–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
5. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
6. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:

–ù–∞ "–ü—Ä–∏–≤–µ—Ç":
"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç MedTour. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö –∏–ª–∏ —Å–∏–º–ø—Ç–æ–º–∞—Ö."

–ù–∞ "–ë–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞":
"–ü—Ä–∏ –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–≤—Ä–æ–ª–æ–≥—É –∏–ª–∏ —Ç–µ—Ä–∞–ø–µ–≤—Ç—É. –í –Ω–∞—à–∏—Ö –∫–ª–∏–Ω–∏–∫–∞—Ö —Ä–∞–±–æ—Ç–∞—é—Ç –æ–ø—ã—Ç–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã: [—Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π]. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è."

–ù–∞ "–ö–∞–∫–∏–µ —É –≤–∞—Å –∫–ª–∏–Ω–∏–∫–∏":
"–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏—Ö –∫–ª–∏–Ω–∏–∫: [—Å–ø–∏—Å–æ–∫ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è–º–∏]"
            """

            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            previous_messages = ChatMessage.objects.filter(session=session).order_by('timestamp')

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è API
            messages = [{"role": "system", "content": system_prompt}]

            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            recent_messages = list(previous_messages)[-2:]
            for prev_msg in recent_messages:
                messages.append({"role": "user", "content": prev_msg.message})
                messages.append({"role": "assistant", "content": prev_msg.response})

            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages.append({"role": "user", "content": message})

            print(f"üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ OpenAI...")
            print(f"üìù –°–æ–æ–±—â–µ–Ω–∏–µ: {message}")

            # –ó–∞–ø—Ä–æ—Å –∫ OpenAI
            response = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=messages,
                max_tokens=500,
                temperature=0.7,
            )

            ai_response = response.choices[0].message.content.strip()
            print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç OpenAI: {ai_response[:50]}...")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            ChatMessage.objects.create(
                session=session,
                message=message,
                response=ai_response,
                timestamp=timezone.now()
            )

            return ai_response

        except Exception as e:
            error_message = str(e).lower()
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_chat_response: {str(e)}")

            if "authentication" in error_message or "api key" in error_message:
                return "‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ OpenAI API. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            elif "rate limit" in error_message or "quota" in error_message:
                return "‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
            elif "insufficient_quota" in error_message:
                return "üí≥ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç—É OpenAI."
            else:
                return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    def get_medical_recommendations(self, symptoms):
        """–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∏–º–ø—Ç–æ–º–∞–º"""
        self.clinics_info = self._get_clinics_info()

        prompt = f"""
–ü–∞—Ü–∏–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏–º–ø—Ç–æ–º—ã: {symptoms}

–ù–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—à–∏—Ö –∫–ª–∏–Ω–∏–∫:
{self.clinics_info}

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
1. –ö –∫–∞–∫–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è
2. –ö–∞–∫—É—é –∫–ª–∏–Ω–∏–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å
3. –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ë–ï–ó –¥–∏–∞–≥–Ω–æ–∑–∞)
4. –°—Ä–æ—á–Ω–æ—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è

–í–ê–ñ–ù–û: –†–µ–∫–æ–º–µ–Ω–¥—É–π —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–ª–∏–Ω–∏–∫–∏!
        """

        try:
            if not client:
                return "–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."

            response = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": f"–¢—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç MedTour. –ö–ª–∏–Ω–∏–∫–∏: {self.clinics_info}"},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=600,
                temperature=0.6,
            )

            return response.choices[0].message.content.strip()

        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∏–º–ø—Ç–æ–º–æ–≤: {str(e)}"

    def clear_chat_history(self, session):
        """–û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
        try:
            ChatMessage.objects.filter(session=session).delete()
            return True
        except Exception as e:
            print(f"Error clearing chat history: {str(e)}")
            return False

    def get_chat_history(self, session, limit=10):
        """–ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"""
        try:
            messages = ChatMessage.objects.filter(session=session).order_by('-timestamp')[:limit]
            return list(reversed(messages))
        except Exception as e:
            print(f"Error getting chat history: {str(e)}")
            return []